#!/bin/bash
# Directories where initrd.gz and bzImage are located
basedir=$(dirname "$(readlink -f "$0")")
: ${SSHPORT=2222}

cmdline='vga=792 quiet console=tty0 console=ttyS0,115200n8'

args=(
    -machine pc,accel=kvm
    -kernel "$basedir/bzImage" -initrd "$basedir/initrd.gz"
    -serial stdio
    #-serial file:$basedir/serial.txt

    -drive media=cdrom,if=virtio,file="$basedir/archlinux.iso"

    -net user,hostfwd=tcp:0:$SSHPORT-:22
    -net nic,model=virtio

    -device usb-ehci # -device usb-kbd
    -vga std -cpu host
    -m 4G -smp $(($(nproc)-1))
    # -vnc :0
)

if [ $# -gt 0 ] && [[ $1 != -* ]]; then
    if [ ! -d "$1" ]; then
        echo "$1: is not a directory that can be exported via virtfs!"
        exit 1
    fi
    # use security_model=mapped-file to create a .virtfs-metadata/ dir in $1.
    # passthrough checks the owner against the accessing user (root cannot
    # create files as the owner of the file cannot be set to root). Therefore
    # use 'none' which silently ignores such errors.
    args+=(
        -virtfs local,mount_tag=shared,security_model=none,path="$1"
    )
    # Ensures writable mountpoint in the guest via a matching uid/gid mapping.
    env=$(find "$1" -maxdepth 1 ! -uid 0 -writable -printf " app.uid=%U" -quit)
    env+=$(find "$1" -maxdepth 1 ! -gid 0 -writable -printf " app.gid=%G" -quit)
    cmdline+="$env"
    shift
fi

args+=(
    -append "$cmdline"
)

qemu-system-x86_64 "${args[@]}" "$@"
